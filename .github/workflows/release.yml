name: Release

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:
    inputs:
      tag:
        description: 'Release tag (e.g., v0.1.0)'
        required: true
        type: string

permissions:
  contents: write

jobs:
  build-binaries:
    name: Build (${{ matrix.os }}, ${{ matrix.arch }})
    runs-on: ${{ matrix.runner }}
    strategy:
      fail-fast: false
      matrix:
        include:
          # Linux
          - os: linux
            arch: amd64
            runner: ubuntu-latest
            ext: ''
          - os: linux
            arch: arm64
            runner: ubuntu-latest
            ext: ''
          # macOS
          - os: darwin
            arch: amd64
            runner: macos-latest
            ext: ''
          - os: darwin
            arch: arm64
            runner: macos-latest
            ext: ''
          # Windows
          - os: windows
            arch: amd64
            runner: windows-latest
            ext: '.exe'
    steps:
      - uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.23'

      - name: Build binaries
        env:
          GOOS: ${{ matrix.os }}
          GOARCH: ${{ matrix.arch }}
          CGO_ENABLED: '0'
        run: |
          # Pure Go binaries (no CGO required)
          go build -ldflags="-s -w" -o luxfhe-gateway-${{ matrix.os }}-${{ matrix.arch }}${{ matrix.ext }} ./cmd/fhe-gateway/
          go build -ldflags="-s -w" -o luxfhe-worker-${{ matrix.os }}-${{ matrix.arch }}${{ matrix.ext }} ./cmd/fhe-worker/

      - name: Upload binaries
        uses: actions/upload-artifact@v4
        with:
          name: luxfhe-${{ matrix.os }}-${{ matrix.arch }}
          path: |
            luxfhe-gateway-${{ matrix.os }}-${{ matrix.arch }}${{ matrix.ext }}
            luxfhe-worker-${{ matrix.os }}-${{ matrix.arch }}${{ matrix.ext }}

  build-c-libraries:
    name: C Library (${{ matrix.os }})
    runs-on: ${{ matrix.runner }}
    strategy:
      fail-fast: false
      matrix:
        include:
          - os: linux
            runner: ubuntu-latest
            lib: libluxfhe.so
          - os: darwin
            runner: macos-latest
            lib: libluxfhe.dylib
          - os: windows
            runner: windows-latest
            lib: luxfhe.dll
    steps:
      - uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.23'

      - name: Build C shared library
        shell: bash
        run: |
          mkdir -p dist
          CGO_ENABLED=1 go build -buildmode=c-shared -o dist/${{ matrix.lib }} ./sdk/c/src/luxfhe.go

      - name: Upload C library
        uses: actions/upload-artifact@v4
        with:
          name: libluxfhe-${{ matrix.os }}
          path: dist/

  build-wasm:
    name: WASM Build
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.23'

      - name: Build WASM
        run: |
          mkdir -p dist
          GOOS=js GOARCH=wasm go build -o dist/luxfhe.wasm ./sdk/wasm/main.go
          cp "$(go env GOROOT)/misc/wasm/wasm_exec.js" dist/

      - name: Upload WASM
        uses: actions/upload-artifact@v4
        with:
          name: luxfhe-wasm
          path: dist/

  build-typescript:
    name: TypeScript SDK
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22'

      - name: Install and build
        working-directory: sdk/typescript
        run: |
          npm ci
          npm run build

      - name: Package
        working-directory: sdk/typescript
        run: npm pack

      - name: Upload package
        uses: actions/upload-artifact@v4
        with:
          name: luxfhe-typescript
          path: sdk/typescript/*.tgz

  create-release:
    name: Create Release
    runs-on: ubuntu-latest
    needs: [build-binaries, build-c-libraries, build-wasm, build-typescript]
    steps:
      - uses: actions/checkout@v4

      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: Prepare release assets
        run: |
          mkdir -p release
          # Binaries
          for dir in artifacts/luxfhe-*; do
            if [ -d "$dir" ]; then
              name=$(basename "$dir")
              if [[ "$name" == luxfhe-linux-* ]] || [[ "$name" == luxfhe-darwin-* ]] || [[ "$name" == luxfhe-windows-* ]]; then
                for f in "$dir"/*; do
                  cp "$f" "release/"
                done
              fi
            fi
          done
          # C libraries
          for os in linux darwin windows; do
            if [ -d "artifacts/libluxfhe-$os" ]; then
              tar -czvf "release/libluxfhe-$os.tar.gz" -C "artifacts/libluxfhe-$os" .
            fi
          done
          # WASM
          if [ -d "artifacts/luxfhe-wasm" ]; then
            tar -czvf "release/luxfhe-wasm.tar.gz" -C "artifacts/luxfhe-wasm" .
          fi
          # TypeScript
          if [ -d "artifacts/luxfhe-typescript" ]; then
            cp artifacts/luxfhe-typescript/*.tgz release/
          fi
          ls -la release/

      - name: Generate checksums
        run: |
          cd release
          sha256sum * > checksums.txt
          cat checksums.txt

      - name: Get tag name
        id: tag
        run: |
          if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            echo "tag=${{ github.event.inputs.tag }}" >> $GITHUB_OUTPUT
          else
            echo "tag=${GITHUB_REF#refs/tags/}" >> $GITHUB_OUTPUT
          fi

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ steps.tag.outputs.tag }}
          name: LuxFHE ${{ steps.tag.outputs.tag }}
          body: |
            ## LuxFHE ${{ steps.tag.outputs.tag }}

            Pure Go implementation of TFHE (Torus Fully Homomorphic Encryption).

            ### Downloads

            #### Binaries (Pure Go - no dependencies)
            | Platform | Architecture | Gateway | Worker |
            |----------|--------------|---------|--------|
            | Linux | amd64 | `luxfhe-gateway-linux-amd64` | `luxfhe-worker-linux-amd64` |
            | Linux | arm64 | `luxfhe-gateway-linux-arm64` | `luxfhe-worker-linux-arm64` |
            | macOS | amd64 | `luxfhe-gateway-darwin-amd64` | `luxfhe-worker-darwin-amd64` |
            | macOS | arm64 | `luxfhe-gateway-darwin-arm64` | `luxfhe-worker-darwin-arm64` |
            | Windows | amd64 | `luxfhe-gateway-windows-amd64.exe` | `luxfhe-worker-windows-amd64.exe` |

            #### SDK Libraries
            - `libluxfhe-linux.tar.gz` - C shared library for Linux
            - `libluxfhe-darwin.tar.gz` - C shared library for macOS
            - `libluxfhe-windows.tar.gz` - C DLL for Windows
            - `luxfhe-wasm.tar.gz` - WebAssembly build
            - `luxfhe-*.tgz` - TypeScript/JavaScript SDK

            #### GPU-Accelerated Server
            Build from source with CGO and [luxcpp/fhe](https://github.com/luxcpp/fhe):
            ```bash
            CGO_ENABLED=1 go build ./cmd/fhe-server
            ```

            ### Verification

            Verify downloads with checksums:
            ```bash
            sha256sum -c checksums.txt
            ```
          files: release/*
          draft: false
          prerelease: ${{ contains(steps.tag.outputs.tag, '-') }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
