name: CI

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  test-go:
    name: Go Tests (${{ matrix.go-version }}, ${{ matrix.os }})
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        go-version: ['1.23']
        os: [ubuntu-latest, macos-latest, windows-latest]
    steps:
      - uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: ${{ matrix.go-version }}

      - name: Download dependencies
        run: go mod download

      - name: Build
        env:
          CGO_ENABLED: '0'
        run: go build ./...

      - name: Test (Unix)
        if: runner.os != 'Windows'
        env:
          CGO_ENABLED: '0'
        run: go test -v -timeout 30m -coverprofile=coverage.out .

      - name: Test (Windows)
        if: runner.os == 'Windows'
        env:
          CGO_ENABLED: '0'
        run: go test -v -timeout 30m .

      - name: Upload coverage
        if: matrix.os == 'ubuntu-latest'
        uses: actions/upload-artifact@v4
        with:
          name: coverage
          path: coverage.out

  test-cgo:
    name: CGO Build (${{ matrix.os }})
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, macos-latest]
    steps:
      - uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.23'

      - name: Build CGO packages
        run: |
          # Test that CGO packages compile (they need external libs at runtime)
          CGO_ENABLED=1 go build -v ./cgo ./gpu ./server ./cmd/fhe-server 2>&1 || echo "CGO build requires external libraries - expected in CI"

  test-c:
    name: C SDK
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.23'

      - name: Build C shared library
        run: |
          mkdir -p sdk/c/lib
          CGO_ENABLED=1 go build -buildmode=c-shared -o sdk/c/lib/libluxfhe.so ./sdk/c/src/luxfhe.go

      - name: Verify library exports
        run: |
          nm -D sdk/c/lib/libluxfhe.so | grep luxfhe | head -20

      - name: Upload C library
        uses: actions/upload-artifact@v4
        with:
          name: libluxfhe-linux
          path: sdk/c/lib/libluxfhe.so

  test-wasm:
    name: WASM SDK
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.23'

      - name: Build WASM
        run: |
          GOOS=js GOARCH=wasm go build -o sdk/wasm/luxfhe.wasm ./sdk/wasm/main.go
          ls -lh sdk/wasm/luxfhe.wasm

      - name: Upload WASM
        uses: actions/upload-artifact@v4
        with:
          name: luxfhe-wasm
          path: sdk/wasm/luxfhe.wasm

  test-typescript:
    name: TypeScript SDK (Node ${{ matrix.node-version }})
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        node-version: ['18', '20', '22']
    steps:
      - uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ matrix.node-version }}

      - name: Install dependencies
        working-directory: sdk/typescript
        run: npm ci

      - name: Type check
        working-directory: sdk/typescript
        run: npm run typecheck

      - name: Build
        working-directory: sdk/typescript
        run: npm run build

      - name: Upload TypeScript dist
        if: matrix.node-version == '22'
        uses: actions/upload-artifact@v4
        with:
          name: luxfhe-ts
          path: sdk/typescript/dist

  test-rust:
    name: Rust SDK
    runs-on: ubuntu-latest
    needs: test-c
    steps:
      - uses: actions/checkout@v4

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Download C library
        uses: actions/download-artifact@v4
        with:
          name: libluxfhe-linux
          path: sdk/c/lib

      - name: Install libclang for bindgen
        run: sudo apt-get update && sudo apt-get install -y libclang-dev

      - name: Check Rust bindings
        working-directory: sdk/rust
        run: cargo check

      - name: Build Rust bindings
        working-directory: sdk/rust
        env:
          LD_LIBRARY_PATH: ${{ github.workspace }}/sdk/c/lib
        run: cargo build --release

  test-python:
    name: Python SDK (${{ matrix.python-version }})
    runs-on: ubuntu-latest
    needs: test-c
    strategy:
      fail-fast: false
      matrix:
        python-version: ['3.9', '3.10', '3.11', '3.12']
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.python-version }}

      - name: Download C library
        uses: actions/download-artifact@v4
        with:
          name: libluxfhe-linux
          path: sdk/c/lib

      - name: Install dependencies
        working-directory: sdk/python
        run: |
          pip install cffi pytest
          pip install -e .

      - name: Run tests
        working-directory: sdk/python
        env:
          LD_LIBRARY_PATH: ${{ github.workspace }}/sdk/c/lib
        run: pytest -v tests/

  benchmark:
    name: Benchmark
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.23'

      - name: Run benchmarks
        env:
          CGO_ENABLED: '0'
        run: go test -bench=BenchmarkLattice -benchmem -run=^$ . | tee benchmark.txt

      - name: Upload benchmark
        uses: actions/upload-artifact@v4
        with:
          name: benchmark
          path: benchmark.txt

  lint:
    name: Lint
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.23'

      - name: Run go vet
        env:
          CGO_ENABLED: '0'
        run: go vet ./...

      - name: Run go fmt check
        run: |
          if [ "$(gofmt -s -l . | wc -l)" -gt 0 ]; then
            echo "The following files need to be formatted:"
            gofmt -s -l .
            exit 1
          fi
