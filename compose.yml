name: luxfhe

services:
  # =============================================================================
  # FHE Server - Standard Mode (port 8448)
  # =============================================================================
  server:
    build:
      context: .
      target: server
    image: ghcr.io/luxfi/fhe/server:latest
    container_name: luxfhe-server
    ports:
      - "8448:8448"
    volumes:
      - fhe-data:/app/data
    healthcheck:
      test: ["CMD", "wget", "-q", "-O", "-", "http://localhost:8448/health"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 5s

  # =============================================================================
  # FHE Server - Threshold Mode (port 8449)
  # =============================================================================
  server-threshold:
    build:
      context: .
      target: server
    image: ghcr.io/luxfi/fhe/server:latest
    container_name: luxfhe-threshold
    ports:
      - "8449:8449"
    command: ["-addr", ":8449", "-threshold", "-parties", "5"]
    volumes:
      - fhe-threshold-data:/app/data
    healthcheck:
      test: ["CMD", "wget", "-q", "-O", "-", "http://localhost:8449/health"]
      interval: 10s
      timeout: 5s
      retries: 5
    profiles:
      - threshold

  # =============================================================================
  # FHE Gateway - Blockchain Event Listener (port 8080)
  # =============================================================================
  gateway:
    build:
      context: .
      target: gateway
    image: ghcr.io/luxfi/fhe/gateway:latest
    container_name: luxfhe-gateway
    ports:
      - "8080:8080"
    environment:
      - RPC_URL=${RPC_URL:-http://host.docker.internal:8545}
    command: ["-http", ":8080", "-redis", "redis:6379", "-storage", "/app/data"]
    volumes:
      - fhe-storage:/app/data
    depends_on:
      redis:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "wget", "-q", "-O", "-", "http://localhost:8080/health"]
      interval: 10s
      timeout: 5s
      retries: 5
    profiles:
      - coprocessor

  # =============================================================================
  # FHE Worker - Computation Workers (port 9090 metrics)
  # =============================================================================
  worker:
    build:
      context: .
      target: worker
    image: ghcr.io/luxfi/fhe/worker:latest
    deploy:
      replicas: 2
    command: ["-redis", "redis:6379", "-storage", "/app/data", "-workers", "4", "-metrics", ":9090"]
    volumes:
      - fhe-storage:/app/data
    depends_on:
      redis:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "wget", "-q", "-O", "-", "http://localhost:9090/health"]
      interval: 10s
      timeout: 5s
      retries: 5
    profiles:
      - coprocessor

  # =============================================================================
  # Redis - Job Queue
  # =============================================================================
  redis:
    image: redis:7-alpine
    container_name: luxfhe-redis
    ports:
      - "6379:6379"
    volumes:
      - redis-data:/data
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 5s
      timeout: 3s
      retries: 3
    profiles:
      - coprocessor

  # =============================================================================
  # Anvil - Local Blockchain for Testing
  # =============================================================================
  anvil:
    image: ghcr.io/foundry-rs/foundry:latest
    container_name: luxfhe-anvil
    entrypoint: ["anvil"]
    command: ["--host", "0.0.0.0", "--chain-id", "96369"]
    ports:
      - "8545:8545"
    profiles:
      - contracts

volumes:
  fhe-data:
  fhe-threshold-data:
  fhe-storage:
  redis-data:
